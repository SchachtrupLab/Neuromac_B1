---
title: "Suvra scSeq"
author: "James Choi"
date: "`r Sys.Date()`"
output:  
  html_document:
    keep_md: true
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
data_inpath <- '../data/raw_counts_good_cells.csv'
cc.genes <- '../ref/regev_lab_cell_cycle_genes.txt'
results_outpath <- '../results/20200329_PreliminaryClustering/'
```

### Loading libraries

```{r load_libraries, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
dir.create(path = results_outpath)
library('SingleCellExperiment')
library('Seurat')
library('dplyr')
library('ggplot2')
```

### Loading data

```{r load_data, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
dat <- read.table(file = data_inpath, sep = ',', header = TRUE, row.names = 1)
dat <- as.matrix(dat)
dat <- Matrix::Matrix(data = dat, sparse = TRUE)
```

### Basic cluster analysis

```{r test_basic_cluster, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, results='hide'}
dat <- dat %>%
  CreateSeuratObject(project = '', names.field = 1) %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA(npcs = 40)
dat <- dat %>%
  FindNeighbors(dims = 1:20) %>%
  RunTSNE(dims = 1:20) %>%
  FindClusters()
dat$orig.ident <- factor(dat$orig.ident, levels = c('SCtrl','S1d','S7d'))
```
```{r test_umaps, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, fig.width=11, fig.height=4.5}
plot1 <- DimPlot(dat, group.by = 'orig.ident') + theme(axis.line = element_line(size = 0.5), axis.ticks = element_blank(), axis.text = element_blank(), axis.title = element_text(size = 10), panel.border = element_rect(color = 'black', fill = NA))
plot2 <- DimPlot(dat, group.by = 'seurat_clusters', label = TRUE, label.size = 6) + theme(axis.line = element_line(size = 0.5), axis.ticks = element_blank(), axis.text = element_blank(), axis.title = element_text(size = 10), panel.border = element_rect(color = 'black', fill = NA))
plot <- cowplot::plot_grid(plot1, plot2, ncol = 2, rel_widths = c(1,0.925))
plot
```

```{r test_markers, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE}
markers <- FindAllMarkers(object = dat, assay = 'RNA', slot = 'data', test.use = 'wilcox', only.pos = TRUE)
```

```{r basic_cluster, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, results='hide'}
firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  return(x)
}
dat <- read.table(file = data_inpath, sep = ',', header = TRUE, row.names = 1) %>%
  as.matrix() %>%
  Matrix::Matrix(sparse = TRUE)
cc.genes <- firstup(tolower(readLines(con = cc.genes)))
s.genes <- intersect(cc.genes[1:43], rownames(dat))
g2m.genes <- intersect(cc.genes[44:97], rownames(dat))
dat <- dat %>%
  CreateSeuratObject(project = '', names.field = 1) %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  CellCycleScoring(s.features = s.genes, g2m.features = g2m.genes)
dat$CC.difference <- dat$S.Score - dat$G2M.Score
dat <- dat %>%
  ScaleData(vars.to.regress = 'CC.difference') %>%
  RunPCA(npcs = 40) %>%
  FindNeighbors(dims = 1:20) %>%
  RunUMAP(dims = 1:20) %>%
  FindClusters()
dat$orig.ident <- factor(dat$orig.ident, levels = c('SCtrl','S1d','S7d'))

```


### Dimensional Reduction + Clustering results

```{r umaps, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, fig.width=11, fig.height=4.5}
plot1 <- DimPlot(dat, group.by = 'orig.ident') + theme(axis.line = element_line(size = 0.5), axis.ticks = element_blank(), axis.text = element_blank(), axis.title = element_text(size = 10), panel.border = element_rect(color = 'black', fill = NA))
plot2 <- DimPlot(dat, group.by = 'seurat_clusters', label = TRUE, label.size = 6) + theme(axis.line = element_line(size = 0.5), axis.ticks = element_blank(), axis.text = element_blank(), axis.title = element_text(size = 10), panel.border = element_rect(color = 'black', fill = NA))
plot <- cowplot::plot_grid(plot1, plot2, ncol = 2, rel_widths = c(1,0.925))
plot
ggsave(filename = paste0(results_outpath, 'umap_results.tiff'), plot = plot, device = 'tiff', height = 4.5, width = 11)
```

### Cluster DE genes

These are globally DE genes i.e. each cluster vs all other cells combined. DE is calculated using a Wilcoxon Rank sum test, which is a conservative approach (low false-positives but high false-negatives).  

```{r markers, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
markers <- FindAllMarkers(object = dat, assay = 'RNA', slot = 'data', test.use = 'wilcox', only.pos = TRUE)
saveRDS(object = markers, file = paste0(results_outpath, 'cluster_markers.rds'))
```

```{r cluster_markers_table, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
markers <- readRDS(file = paste0(results_outpath, 'cluster_markers.rds'))
markers <- markers[c(6,7,2,5,1,3,4)]
markers[c('p_val_adj','avg_logFC','p_val','pct.1','pct.2')] <- signif(markers[c('p_val_adj','avg_logFC','p_val','pct.1','pct.2')]
, digits = 3)
DT::datatable(data = markers, rownames = FALSE, extensions = c('Scroller','Buttons'), options = list(scroller = TRUE, deferRender = TRUE, scrollY = 350, fixedColumns = TRUE, autoWidth = TRUE, pageLength = 10, dom = 'Bfrtip', buttons = list(extend = 'collection', buttons = c('csv', 'excel', 'pdf'))))
```

Heatmap of the top 7 DE genes for each cluster. Some clusters have overlapping globally-DE genes (e.g. cluster 4 with clusters 0 and 6).  

```{r cluster_markers_heatmap, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, fig.width=4, fig.height=9, fig.align='center'}
marker.genes <- markers %>% arrange(cluster) %>% filter(p_val_adj < 1e-3) %>% group_by(cluster) %>% top_n(n = 7, wt = avg_logFC)
marker.genes <- unique(marker.genes[['gene']])
Idents(dat) <- 'seurat_clusters'
DefaultAssay(dat) <- 'RNA'
dat <- ScaleData(dat, features = marker.genes)
avg.exp <- FetchData(dat, vars = c('ident', marker.genes), slot = 'scale.data') %>%
  reshape2::melt(id.vars = c('ident')) %>%
  arrange(ident) %>%
  group_by(ident, variable) %>%
  summarise(avg.exp = mean(value)) %>%
  mutate(variable = factor(variable, levels = rev(levels(variable))))
marker.heatmap <- avg.exp %>%
  ggplot(mapping = aes(x = ident, y = variable, fill = avg.exp)) +
  geom_tile(color = 'black', size = 0.5) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  scale_fill_gradient2(low = "#2166AC", mid = "#F7F7F7", high = "#B2182B", limits = c(NA, 2), na.value ="#B2182B") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1),
        axis.title = element_blank()) +
  guides(fill = guide_colorbar(title = 'Expression\nz-score', barwidth = 1.25, frame.colour = 'black', frame.linewidth = 1, ticks.colour = 'black', ticks.linewidth = 1))

marker.heatmap
ggsave(filename = paste0(results_outpath, 'cluster_markers_heatmap.tiff'),plot = marker.heatmap, device = 'tiff', height = 9, width = 4)
```

### Cluster dynamics

Next we explore the population changes for each of the clusters between the 3 conditions. We calculate the absolute numbers of cells per cluster as well as the proportion out of all cells for each condition. We observe that the composition of clusters are similar between the SCtrl and S7d groups, while S1d is distinct. Clusters 2 and 6 are only present in S1d and virtually absent in SCtrl and S7d. Moreover, clusters 0 and 4 are virtually absent in S1d and clearly present in SCtrl and S7d.  

```{r population_dynamics, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, fig.align='center', fig.width=8, fig.height=3.75}
counts <- data.frame(table(dat$seurat_clusters, dat$orig.ident))
names(counts) <- c('seurat_clusters','orig.ident','count')
numbers <- counts %>%
  ggplot(mapping = aes(x = orig.ident, y = count, group = seurat_clusters)) + 
  geom_bar(aes(fill = seurat_clusters), stat = 'identity', color = 'black', size = 0.75) +
  scale_y_continuous() +
  scale_x_discrete() + 
  ylab('# of cells') + 
  theme(axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12), 
        axis.line = element_line(size = 1),
        panel.background = element_rect(fill = NA),
        axis.text.y = element_text(size = 12))
props <- counts %>% 
  ggplot(mapping = aes(x = orig.ident, y = count, group = seurat_clusters)) + 
  geom_bar(aes(fill = seurat_clusters), stat = 'identity', color = 'black', size = 0.75, position = 'fill') +
  scale_y_continuous() + 
  scale_x_discrete() +
  ylab('% of cells') + 
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.line = element_line(size = 1), 
        panel.background = element_rect(fill = NA), 
        axis.text.y = element_text(size = 12), 
        legend.title = element_blank(), 
        legend.text = element_text(size = 12))
legend <- cowplot::get_legend(plot = props)
pop.dynamics <- cowplot::plot_grid(numbers + theme(legend.position = 'none'), props + theme(legend.position = 'none'), legend, ncol = 3, rel_widths = c(1, 1, 0.25))

pop.dynamics
ggsave(filename = paste0(results_outpath, 'population_dynamics.tiff'), plot = pop.dynamics, device = 'tiff', height = 3.75, width = 8)
```

```{r sessionInfo, results='hide'}
sessionInfo()
```